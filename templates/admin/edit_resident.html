{% extends "admin/base_admin.html" %}

{% block title %}Chỉnh sửa nhân khẩu - Admin{% endblock %}

{% block page_title %}Chỉnh sửa nhân khẩu{% endblock %}

{% block extra_css %}
<style>
  #addressSearchWrapperEdit { position: relative; }
  #addressSuggestionsEdit {
    position: absolute;
    top: 100%; left: 0; right: 0;
    background: #fff;
    border: 1px solid #ddd;
    border-top: none;
    z-index: 2000;
    max-height: 220px;
    overflow-y: auto;
    display: none;
    box-shadow: 0 4px 10px rgba(0,0,0,0.08);
  }
  #addressSuggestionsEdit .suggest-item {
    padding: 8px 10px;
    cursor: pointer;
    font-size: 0.95rem;
  }
  #addressSuggestionsEdit .suggest-item:hover {
    background: #f7f7f7;
  }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-user-edit me-2"></i>Chỉnh sửa: {{ resident.full_name }}</h2>
                <a href="{{ url_for('admin.household_residents', id=household.id) }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-1"></i>Quay lại
                </a>
            </div>

            <div class="card shadow">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">Thông tin nhân khẩu</h5>
                </div>
                <div class="card-body">
                    <form method="POST">
                        {{ form.hidden_tag() }}

                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    {{ form.full_name.label(class="form-label required") }}
                                    {{ form.full_name(class="form-control" + (" is-invalid" if form.full_name.errors else "")) }}
                                    {% if form.full_name.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.full_name.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    {{ form.gender.label(class="form-label required") }}
                                    {{ form.gender(class="form-select" + (" is-invalid" if form.gender.errors else "")) }}
                                    {% if form.gender.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.gender.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    {{ form.birth_date.label(class="form-label required") }}
                                    {{ form.birth_date(class="form-control" + (" is-invalid" if form.birth_date.errors else "")) }}
                                    {% if form.birth_date.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.birth_date.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    {{ form.relationship.label(class="form-label required") }}
                                    {{ form.relationship(class="form-select" + (" is-invalid" if form.relationship.errors else "")) }}
                                    {% if form.relationship.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.relationship.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    {{ form.id_number.label(class="form-label") }}
                                    {{ form.id_number(class="form-control" + (" is-invalid" if form.id_number.errors else "")) }}
                                    {% if form.id_number.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.id_number.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                    <div class="form-text">CMND hoặc CCCD</div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            {{ form.occupation.label(class="form-label") }}
                            {{ form.occupation(class="form-control" + (" is-invalid" if form.occupation.errors else "")) }}
                            {% if form.occupation.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.occupation.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            {{ form.phone.label(class="form-label") }}
                            {{ form.phone(class="form-control" + (" is-invalid" if form.phone.errors else "")) }}
                            {% if form.phone.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.phone.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="mb-4">
                            {{ form.notes.label(class="form-label") }}
                            {{ form.notes(class="form-control" + (" is-invalid" if form.notes.errors else ""), rows="3") }}
                            {% if form.notes.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.notes.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Vị trí trên bản đồ</label>
                            <div id="addressSearchWrapperEdit" class="mb-2">
                                <input id="addressSearchEdit" class="form-control" type="text" placeholder="Tìm địa chỉ (ví dụ: xã, thôn, đường...)" autocomplete="off" />
                                <div id="addressSuggestionsEdit"></div>
                                <div class="form-text">Gõ ít nhất 3 ký tự để tìm. Chọn gợi ý để đặt vị trí.</div>
                            </div>
                            <div id="residentMapEdit" style="height: 300px; border: 1px solid #ddd; border-radius: 8px;"></div>
                            <div id="residentMapNotice" class="form-text" style="display:none">Không tải được nền bản đồ. Bạn vẫn có thể nhấp để chọn tọa độ.</div>
                            <div class="row mt-2">
                                <div class="col-md-6">
                                    {{ form.current_lat.label(class="form-label") }}
                                    {{ form.current_lat(class="form-control") }}
                                </div>
                                <div class="col-md-6">
                                    {{ form.current_lng.label(class="form-label") }}
                                    {{ form.current_lng(class="form-control") }}
                                </div>
                            </div>
                            <div class="form-text">Nhấp vào bản đồ để cập nhật vị trí hiện tại của nhân khẩu.</div>
                        </div>

                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('admin.household_residents', id=household.id) }}" class="btn btn-secondary">
                                <i class="fas fa-times me-1"></i>Hủy
                            </a>
                            <button type="submit" class="btn btn-warning">
                                <i class="fas fa-save me-1"></i>Cập nhật
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    (function(){
        if (!window.L) {
            console.warn('Leaflet chưa tải. Kiểm tra kết nối mạng/CDN.');
            return;
        }
        var latEl = document.querySelector('[name="current_lat"]');
        var lngEl = document.querySelector('[name="current_lng"]');
        var lat = latEl && latEl.value ? parseFloat(latEl.value) : 21.0;
        var lng = lngEl && lngEl.value ? parseFloat(lngEl.value) : 105.0;
        var map = L.map('residentMapEdit').setView([lat, lng], (latEl && lngEl && latEl.value && lngEl.value) ? 14 : 12);
        var providers = [
            'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
            'https://tile.openstreetmap.org/{z}/{x}/{y}.png',
            'https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png'
        ];
        var noticeEl = document.getElementById('residentMapNotice');
        function addTiles(idx){
            if (idx >= providers.length) { if (noticeEl) noticeEl.style.display = 'block'; return; }
            var layer = L.tileLayer(providers[idx], {maxZoom: 19, attribution: '&copy; OpenStreetMap contributors'}).addTo(map);
            layer.on('tileerror', function(){
                map.removeLayer(layer);
                addTiles(idx+1);
            });
        }
        addTiles(0);
        var marker;
        if(latEl && lngEl && latEl.value && lngEl.value){
            marker = L.marker([lat, lng]).addTo(map);
        }
        function updateFields(latlng){
            if(latEl) latEl.value = latlng.lat.toFixed(6);
            if(lngEl) lngEl.value = latlng.lng.toFixed(6);
        }
        map.on('click', function(e){
            if(marker){ map.removeLayer(marker); }
            marker = L.marker(e.latlng).addTo(map);
            updateFields(e.latlng);
        });

        // Address search with suggestions (Nominatim)
        var searchInput = document.getElementById('addressSearchEdit');
        var suggestBox = document.getElementById('addressSuggestionsEdit');
        var debounceTimer;
        function clearSuggestions(){
            if(!suggestBox) return;
            suggestBox.innerHTML = '';
            suggestBox.style.display = 'none';
        }
        function renderSuggestions(results){
            if(!suggestBox) return;
            suggestBox.innerHTML = results.map(function(r){
                var label = r.display_name || (r.address && r.address.road) || 'Kết quả';
                return '<div class="suggest-item" data-lat="'+r.lat+'" data-lon="'+r.lon+'">'+label+'</div>';
            }).join('');
            suggestBox.style.display = 'block';
            Array.from(suggestBox.querySelectorAll('.suggest-item')).forEach(function(el){
                el.addEventListener('click', function(){
                    var slat = parseFloat(this.dataset.lat);
                    var slon = parseFloat(this.dataset.lon);
                    var latlng = {lat: slat, lng: slon};
                    if(marker){ map.removeLayer(marker); }
                    marker = L.marker(latlng).addTo(map);
                    updateFields(latlng);
                    map.flyTo([slat, slon], 16);
                    if(searchInput) searchInput.value = this.textContent;
                    clearSuggestions();
                });
            });
        }
        function searchAddress(q){
            var url = 'https://nominatim.openstreetmap.org/search?format=jsonv2&countrycodes=VN&limit=5&q=' + encodeURIComponent(q);
            fetch(url, { headers: { 'Accept-Language': 'vi' } })
                .then(function(res){ return res.json(); })
                .then(function(data){
                    if(Array.isArray(data) && data.length){
                        renderSuggestions(data);
                    } else {
                        clearSuggestions();
                    }
                })
                .catch(function(err){ console.warn('Geocode error', err); clearSuggestions(); });
        }
        if(searchInput){
            searchInput.addEventListener('input', function(){
                var q = this.value.trim();
                clearTimeout(debounceTimer);
                if(q.length < 3){ clearSuggestions(); return; }
                debounceTimer = setTimeout(function(){ searchAddress(q); }, 300);
            });
        }
        document.addEventListener('click', function(e){
            if(!e.target.closest('#addressSearchWrapperEdit')){ clearSuggestions(); }
        });
    })();
</script>
{% endblock %}
