{% extends "admin/base_admin.html" %}

{% block title %}Thêm hộ gia đình - Admin{% endblock %}

{% block page_title %}Thêm hộ gia đình mới{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-home me-2"></i>Thêm hộ gia đình mới</h2>
                <a href="{{ url_for('admin.population') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-1"></i>Quay lại
                </a>
            </div>
            
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">Thông tin hộ gia đình</h5>
                </div>
                <div class="card-body">
                    <form method="POST" novalidate>
                        {{ form.hidden_tag() }}
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.household_code.label(class="form-label required") }}
                                    {{ form.household_code(class="form-control" + (" is-invalid" if form.household_code.errors else "")) }}
                                    {% if form.household_code.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.household_code.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    <div class="form-text">Mã số duy nhất của hộ gia đình</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.hamlet.label(class="form-label required") }}
                                    {{ form.hamlet(class="form-select" + (" is-invalid" if form.hamlet.errors else "")) }}
                                    {% if form.hamlet.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.hamlet.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            {{ form.head_of_household.label(class="form-label required") }}
                            {{ form.head_of_household(class="form-control" + (" is-invalid" if form.head_of_household.errors else ""), pattern="^[A-Za-zÀ-ỹ\s]+$", title="Chỉ nhập chữ cái và khoảng trắng") }}
                            {% if form.head_of_household.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.head_of_household.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">Chỉ nhập chữ cái và khoảng trắng (không nhập số/ký tự đặc biệt)</div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.head_id_number.label(class="form-label") }}
                                    {{ form.head_id_number(class="form-control" + (" is-invalid" if form.head_id_number.errors else "")) }}
                                    {% if form.head_id_number.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.head_id_number.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.head_birth_date.label(class="form-label") }}
                                    {{ form.head_birth_date(class="form-control" + (" is-invalid" if form.head_birth_date.errors else "")) }}
                                    {% if form.head_birth_date.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.head_birth_date.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.head_occupation.label(class="form-label") }}
                                    {{ form.head_occupation(class="form-control" + (" is-invalid" if form.head_occupation.errors else "")) }}
                                    {% if form.head_occupation.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.head_occupation.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.head_gender.label(class="form-label") }}
                                    {{ form.head_gender(class="form-select" + (" is-invalid" if form.head_gender.errors else "")) }}
                                    {% if form.head_gender.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.head_gender.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            {{ form.address.label(class="form-label required") }}
                            {{ form.address(class="form-control" + (" is-invalid" if form.address.errors else "")) }}
                            {% if form.address.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.address.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">Địa chỉ chi tiết (số nhà, tên đường...)</div>
                        </div>
                        
                        <div class="mb-4">
                            {{ form.phone.label(class="form-label") }}
                            {{ form.phone(class="form-control" + (" is-invalid" if form.phone.errors else "")) }}
                            {% if form.phone.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.phone.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Vị trí trên bản đồ</label>
                            <div id="addressSearchWrapperHH" class="mb-2">
                                <input id="addressSearchHH" class="form-control" type="text" placeholder="Tìm địa chỉ (ví dụ: xã, thôn, đường...)" autocomplete="off" />
                                <div id="addressSuggestionsHH"></div>
                                <div class="form-text">Gõ ít nhất 3 ký tự để tìm. Chọn gợi ý để đặt vị trí.</div>
                            </div>
                            <div id="householdMapAdd" style="height: 300px; border: 1px solid #ddd; border-radius: 8px;"></div>
                            <div id="householdMapNotice" class="form-text" style="display:none">Không tải được nền bản đồ. Bạn vẫn có thể nhấp để chọn tọa độ.</div>
                            <div class="row mt-2">
                                <div class="col-md-6">
                                    <label class="form-label" for="current_lat">Vĩ độ (lat)</label>
                                    <input type="text" name="current_lat" id="current_lat" class="form-control" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label" for="current_lng">Kinh độ (lng)</label>
                                    <input type="text" name="current_lng" id="current_lng" class="form-control" />
                                </div>
                            </div>
                            <div class="form-text">Nhấp vào bản đồ để chọn vị trí. Tọa độ sẽ tự điền và địa chỉ sẽ được gợi ý.</div>
                        </div>
                        
                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('admin.population') }}" class="btn btn-secondary">
                                <i class="fas fa-times me-1"></i>Hủy
                            </a>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save me-1"></i>Thêm hộ gia đình
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.required::after {
    content: " *";
    color: red;
}
#addressSearchWrapperHH { position: relative; }
#addressSuggestionsHH {
  position: absolute;
  top: 100%; left: 0; right: 0;
  background: #fff;
  border: 1px solid #ddd;
  border-top: none;
  z-index: 2000;
  max-height: 220px;
  overflow-y: auto;
  display: none;
  box-shadow: 0 4px 10px rgba(0,0,0,0.08);
}
#addressSuggestionsHH .suggest-item {
  padding: 8px 10px;
  cursor: pointer;
  font-size: 0.95rem;
}
#addressSuggestionsHH .suggest-item:hover { background: #f7f7f7; }
</style>
{% endblock %}

{% block extra_js %}
<script>
    (function(){
        if (!window.L) {
            console.warn('Leaflet chưa tải. Kiểm tra kết nối mạng/CDN.');
            return;
        }
        var map = L.map('householdMapAdd').setView([21.0, 105.0], 12);
        var providers = [
            'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
            'https://tile.openstreetmap.org/{z}/{x}/{y}.png',
            'https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png'
        ];
        var noticeEl = document.getElementById('householdMapNotice');
        function addTiles(idx){
            if (idx >= providers.length) { if (noticeEl) noticeEl.style.display = 'block'; return; }
            var layer = L.tileLayer(providers[idx], {maxZoom: 19, attribution: '&copy; OpenStreetMap contributors'}).addTo(map);
            layer.on('tileerror', function(){
                map.removeLayer(layer);
                addTiles(idx+1);
            });
        }
        addTiles(0);

        var marker;
        var latInput = document.querySelector('[name="current_lat"]');
        var lngInput = document.querySelector('[name="current_lng"]');
        var addressInput = document.getElementById('address');

        function updateFields(latlng){
            if(latInput) latInput.value = latlng.lat.toFixed(6);
            if(lngInput) lngInput.value = latlng.lng.toFixed(6);
        }

        function reverseGeocode(lat, lon){
            var url = 'https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat='+lat+'&lon='+lon+'&addressdetails=1';
            fetch(url, { headers: { 'Accept-Language': 'vi' } })
                .then(function(res){ return res.json(); })
                .then(function(data){
                    // Không ghi đè trường địa chỉ hộ. Chỉ cập nhật tọa độ.
                })
                .catch(function(err){ console.warn('Reverse geocode error', err); });
        }

        map.on('click', function(e){
            if(marker){ map.removeLayer(marker); }
            marker = L.marker(e.latlng).addTo(map);
            updateFields(e.latlng);
            reverseGeocode(e.latlng.lat, e.latlng.lng);
        });

        // Address search with suggestions (Nominatim), bounded by current map view
        var searchInput = document.getElementById('addressSearchHH');
        var suggestBox = document.getElementById('addressSuggestionsHH');
        var debounceTimer;
        function clearSuggestions(){
            if(!suggestBox) return;
            suggestBox.innerHTML = '';
            suggestBox.style.display = 'none';
        }
        function renderSuggestions(results){
            if(!suggestBox) return;
            suggestBox.innerHTML = results.map(function(r){
                var label = r.display_name || (r.address && r.address.road) || 'Kết quả';
                return '<div class="suggest-item" data-lat="'+r.lat+'" data-lon="'+r.lon+'">'+label+'</div>';
            }).join('');
            suggestBox.style.display = 'block';
            Array.from(suggestBox.querySelectorAll('.suggest-item')).forEach(function(el){
                el.addEventListener('click', function(){
                    var slat = parseFloat(this.dataset.lat);
                    var slon = parseFloat(this.dataset.lon);
                    var latlng = {lat: slat, lng: slon};
                    if(marker){ map.removeLayer(marker); }
                    marker = L.marker(latlng).addTo(map);
                    updateFields(latlng);
                    map.flyTo([slat, slon], 16);
                    if(searchInput) searchInput.value = this.textContent;
                    clearSuggestions();
                });
            });
        }
        function searchAddress(q){
            var b = map.getBounds();
            var viewbox = [b.getWest(), b.getNorth(), b.getEast(), b.getSouth()].join(',');
            var url = 'https://nominatim.openstreetmap.org/search?format=jsonv2&countrycodes=VN&limit=7&bounded=1&viewbox=' + encodeURIComponent(viewbox) + '&q=' + encodeURIComponent(q);
            fetch(url, { headers: { 'Accept-Language': 'vi' } })
                .then(function(res){ return res.json(); })
                .then(function(data){
                    if(Array.isArray(data) && data.length){
                        renderSuggestions(data);
                    } else {
                        clearSuggestions();
                    }
                })
                .catch(function(err){ console.warn('Geocode error', err); clearSuggestions(); });
        }
        if(searchInput){
            searchInput.addEventListener('input', function(){
                var q = this.value.trim();
                clearTimeout(debounceTimer);
                if(q.length < 3){ clearSuggestions(); return; }
                debounceTimer = setTimeout(function(){ searchAddress(q); }, 300);
            });
        }
        document.addEventListener('click', function(e){
            if(!e.target.closest('#addressSearchWrapperHH')){ clearSuggestions(); }
        });
    })();
</script>
{% endblock %}
