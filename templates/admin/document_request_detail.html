{% extends "admin/base_admin.html" %}

{% block title %}Xử lý yêu cầu giấy tờ{% endblock %}
{% block page_title %}Xử lý yêu cầu #{{ dr.id }}{% endblock %}

{% block content %}
<div class="row g-3">
  <div class="col-lg-8">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title">Thông tin yêu cầu</h5>
        <div class="row">
          <div class="col-md-6">
            <div class="mb-2"><strong>Loại giấy tờ:</strong> {{ doc_type.name }}</div>
            <div class="mb-2"><strong>Trạng thái:</strong> <span class="badge bg-{{ dr.status | doc_status_badge }}">{{ dr.status | doc_status }}</span></div>
            <div class="mb-2"><strong>Gửi lúc:</strong> {{ dr.submitted_at | vn_datetime('%d/%m/%Y %H:%M') }}</div>
          </div>
          <div class="col-md-6">
            <div class="mb-2"><strong>Người nộp:</strong> {{ user.full_name }}</div>
            <div class="mb-2"><strong>Họ tên trong hồ sơ:</strong> {{ dr.applicant_full_name }}</div>
            <div class="mb-2"><strong>SĐT:</strong> {{ dr.applicant_phone or '-' }}</div>
          </div>
        </div>
        <div class="mt-3">
          <strong>Ghi chú của người nộp:</strong>
          <div class="border rounded p-2 bg-light">{{ dr.notes or '—' }}</div>
        </div>
      </div>
    </div>

    <div class="card mt-3">
      <div class="card-body">
        <h5 class="card-title">Tệp đính kèm</h5>
        {% if attachments %}
        <ul class="list-group list-group-flush">
          {% for p in attachments %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <span class="text-truncate" style="max-width: 70%">{{ p }}</span>
            <a class="btn btn-sm btn-outline-secondary" href="/uploads/{{ p }}" target="_blank">Xem</a>
          </li>
          {% endfor %}
        </ul>
        {% else %}
        <div class="text-muted">Không có tệp đính kèm</div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title">Cập nhật trạng thái</h5>
        {% if current_user.role == 'admin' %}
        <form method="post">
          <div class="mb-3">
            <label class="form-label">Trạng thái</label>
            <select name="status" class="form-select">
              {% for s,v in [('pending','Chờ duyệt'),('in_review','Đang duyệt'),('approved','Đã duyệt'),('rejected','Từ chối'),('completed','Hoàn tất')] %}
              <option value="{{ s }}" {% if dr.status==s %}selected{% endif %}>{{ v }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Ghi chú cán bộ</label>
            <textarea name="admin_comment" class="form-control" rows="4">{{ dr.admin_comment or '' }}</textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">Ngày hẹn trả dự kiến</label>
            <input type="date" name="expected_pickup_date" class="form-control" value="{{ dr.expected_pickup_date.strftime('%Y-%m-%d') if dr.expected_pickup_date else '' }}" />
          </div>
          <button class="btn btn-primary" type="submit"><i class="fas fa-save me-1"></i>Lưu</button>
        </form>
        {% else %}
        <div class="alert alert-warning">Chế độ chỉ xem. Bạn không có quyền thao tác.</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
